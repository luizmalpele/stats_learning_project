---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r}
library(tidyverse)
library(caret)
library(fastDummies)
library(leaps)
```

```{r}
onlineCourses <- read.csv("https://raw.githubusercontent.com/reisanar/datasets/master/harvardMIT.csv")
```

```{r}
onlineCourses2 <- onlineCourses %>% dummy_cols(select_columns = "Course.Subject") 
onlineCourses2
```


## Introduction

(TO BE DONE) - Miguel Amaral


## Renaming Variables

```{r}
online_courses <- onlineCourses2 %>% rename(participants = Participants..Course.Content.Accessed., institution = Institution, course_number = Course.Number, launch_date = Launch.Date, course = Course.Title, instructors = Instructors, subject = Course.Subject, year = Year, honor_certificate = Honor.Code.Certificates, half_completed = 
Audited....50..Course.Content.Accessed., completed = Certified, completed_ratio = X..Certified, half_completed_ratio = 
X..Audited, completed_given_half_ratio = X..Certified.of...50..Course.Content.Accessed, played_video_ratio = X..Played.Video, posted_forum_ratio = X..Posted.in.Forum, grade_above_zero = X..Grade.Higher.Than.Zero, course_hours = Total.Course.Hours..Thousands., hours_certification_median = Median.Hours.for.Certification, age_median = Median.Age, male_ratio = X..Male, female_ratio = X..Female, bachelor_ratio = X..Bachelor.s.Degree.or.Higher, subject_cs =  "Course.Subject_Computer Science", subject_gov = "Course.Subject_Government, Health, and Social Science", subject_hum = "Course.Subject_Humanities, History, Design, Religion, and Education", subject_stem = "Course.Subject_Science, Technology, Engineering, and Mathematics") %>%
  mutate(ln_participants = log(participants), ln_completed_ratio = log(completed_ratio))
online_courses
```

__Transforming Inf value into NA__

```{r}
cf_DFinf2NA <- function(x)
{
    for (i in 1:ncol(x)){
          x[,i][is.infinite(x[,i])] = NA
    }
    return(x)
}
online_courses <- cf_DFinf2NA(online_courses)
online_courses
```


## Data Dictionary


|Field Name | Description | Data Type | Data Size| Format|
|:----------|:---------------|:---------|:------------|
|institution|Name of institution|Factor|290|MITx|
|course_number|Number of course|Factor|290|6.002x|
|launch_day|Day the course started|Factor|290|09/05/2012|
|course|Name of the course|Factor|290|Circuits and Electronics|
|instructures|Name of instructors|Factor|290|Khurram Afridi|
|subject|Course area (STEM, Science, Computer Science, or Humanities)|Factor|290|Science, Technology, Engineering, and Mathematics|
|year|University years ranking|Integer|290|1|
|honor_certificate|If the course is part of the honor code certificate|Integer|290|1|
|participants|Total number of enrolled students in the course|Integer|290|36105|
|half_completed|Number of students who completed half of the course|Integer|290|5431|
|completed|Number of students who completed the course|Integer|290|3003|
|half_completed_ratio| Ratio of students who completed half of the course given total number of enrolled students in the course|Double|290|15.04|
|completed_ratio|Ratio of students who completed the course given total number of enrolled students in the course|Double|290|8.32|
|completed_given_half_ratio|Ratio of students who completed the course given students who completed half of the course|Double|290|54.98|
|played_video_ratio|Percentage of students who played the class videos|Factor|290|83.2|
|posted_forum_ratio|Percentage of students who posted on the class forum|Double|290|8.17|
|grade_above_zero|Percentage of students who scored more than zero in the class|Double|290|28.97|
|course_hours|Total number of hours of the course|Double|290|418.94|
|hours_certification_median|Median number of hours it takes to get the certification|Double|290|64.45|
|age_median|Median age of students who took the course|Double|290|26.0|
|male_ratio|Percentage of male students given the total number of participants|Double|290|88.28|
|female_ratio|Percentage of female students given the total number of participants|Double|290|11.72|
|bachelor_ratio| Percentage of students who has a bachelor degree|Double|290|60.68|
|subject_cs|Course in the Computer Science study area|Integer|290|0|
|subject_gov|Course in the Government, Health, and Social Science study area|Integer|290|0|
|subject_hum|Course in the Humanities, History, Design, Religion, and Educatione study area|Integer|290|0|
|subject_stem|Course in the Science, Technology, Engineering, and Mathematics study area|Integer|290|1|
|ln_participants|Natural logarithm of the total number of participants in the course|Double|290|10.494187	|
|ln_completed_ratio|Natural logarithm of the ratio of students who completed the course given total number of enrolled students in the course|Double|290|2.11866225|

__Important information related to the data:__

- The log transformed variable for course participants is approximately normal
- The log transformed variable for completed ratio is closer to a normal distribution than the original variable.

__EDA__

```{r}
online_courses %>% 
  group_by(year) %>% 
  summarize(average_certified = mean(completed_ratio),sd_certified_ratio = sd(completed_ratio))
```


```{r}
ggplot(data=online_courses) + geom_histogram(mapping = aes(x = hours_certification_median))
ggplot(data=online_courses) + geom_histogram(mapping = aes(x = ln_participants))
ggplot(data=online_courses) + geom_histogram(mapping = aes(x = ln_completed_ratio))
ggplot(data=online_courses) + geom_histogram(mapping = aes(x = completed_ratio))
```

```{r}
online_courses_shrinked <- online_courses %>% select(institution, subject, year, ln_participants, half_completed, half_completed_ratio, completed_ratio, grade_above_zero, course_hours, bachelor_ratio, hours_certification_median, age_median, subject_cs, subject_gov, subject_hum, subject_stem)
online_courses_shrinked
```

```{r}
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...) 
{ 
    usr <- par("usr"); on.exit(par(usr)) 
    par(usr = c(0, 1, 0, 1)) 
    r <- abs(cor(x, y)) 
    txt <- format(c(r, 0.123456789), digits = digits)[1] 
    txt <- paste0(prefix, txt) 
    if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt) 
    text(0.5, 0.5, txt, cex = cex.cor * r) 
} 

pairs(online_courses_shrinked, lower.panel = panel.smooth, upper.panel = panel.cor, 
      gap=0, row1attop=FALSE) 
```

## Exploring correlation between variables

```{r}
online_courses %>% mutate(age_categories = cut(age_median, seq(20,55,3), right=FALSE)) %>%  ggplot() + geom_boxplot(aes(x=age_categories, y=hours_certification_median))
online_courses %>% mutate(age_categories = cut(age_median, seq(20,55,3), right=FALSE)) %>%  ggplot() + geom_boxplot(aes(x=age_categories, y=completed_ratio))
online_courses %>% mutate(completed_ratio_categories = cut(completed_ratio, seq(0,100,5), right=FALSE)) %>%  ggplot() + geom_boxplot(aes(x=completed_ratio_categories, y=age_median))
online_courses %>%  ggplot() + geom_boxplot(aes(x=institution, y=completed_ratio))
online_courses %>% mutate(grade_above_zero_categories = cut(grade_above_zero, seq(0,56,8), right=FALSE)) %>% ggplot() + geom_boxplot(aes(x=grade_above_zero_categories, y=completed_ratio))
online_courses %>% mutate(bachelor_ratio_categories = cut(bachelor_ratio, seq(40,100,5), right=FALSE)) %>%  ggplot() + geom_boxplot(aes(x=bachelor_ratio_categories, y=completed_ratio))
online_courses %>% mutate(hours_certification_median_categories = cut(hours_certification_median, seq(0,100,10), right=FALSE)) %>%  ggplot() + geom_boxplot(aes(x=hours_certification_median_categories, y=completed_ratio))
online_courses %>%  ggplot() + geom_point(aes(x=hours_certification_median, y=completed_ratio))
online_courses %>% gather(subject_cs, subject_gov, subject_hum, subject_stem, key = "subject", value = "boolean_auxiliar") %>% filter(boolean_auxiliar == 1) %>% ggplot() + geom_boxplot(aes(x=subject, y=completed_ratio))
```

## Linear Models

__Filtering NA values__

```{r}
lm_online_data <- online_courses %>% filter(!is.na(ln_completed_ratio))
lm_online_data
```

__Separating the data into Train and Test__

```{r}
set.seed(123)
train_control <-  trainControl(method = "cv", number = 10)
inTrain <- createDataPartition(y = lm_online_data$ln_completed_ratio, p = 0.7, list = FALSE)
train_set <- lm_online_data[inTrain , ]
test_set <- lm_online_data[-inTrain , ]
```

__Variables selection__

```{r}
#Separating the data
sub_fit_certified <- regsubsets(ln_completed_ratio ~ institution + subject_stem + subject_cs + hours_certification_median + year + age_median + bachelor_ratio + grade_above_zero , data = train_set)
best_summary <- summary(sub_fit_certified)

#Plots
par(mfrow = c(1,2))
plot(best_summary$cp, xlab = "number of features", ylab = "cp")
plot(sub_fit_certified, scale = "Cp")
par(mfrow = c(1,2))
plot(best_summary$adjr2)
plot(best_summary$bic)
```

 Based on BIC, Mallows' CP, and the $Adjusted-R^2$, the select model will account for 5 variables, more than this will result in overfitting and these variables will be: _instution, subject_cs, hours_certification_median, _bachelor_ratio, subject_stem, and grade_above_zero_. 
 
# Modeling With other Techniques

## Simple Limnear Regression
 
```{r}
 lm_train_courses <- lm(ln_completed_ratio ~ institution + subject_cs + subject_stem + hours_certification_median + bachelor_ratio + grade_above_zero, 
                        data = train_set)
summary(lm_train_courses)
```
 
```{r}
lm_test_courses <- predict(lm_train_courses, test_set)
RMSE1 <- mean((lm_test_courses - test_set$ln_completed_ratio)^2) 
RMSE1

#Test Data
unlog_forecast_lm <- exp(lm_test_courses)
unlog_actual <- exp(test_set$ln_completed_ratio)
ggplot(test_set, aes(x = unlog_forecast_lm, y = unlog_actual)) + 
  geom_point() + 
  geom_smooth(method = lm) +  labs(title = "Forecast versus Actuals - Simple Linear Regression (Test Data)", x = "Forecast", y = "Actual")

#Training Data
lm_train_data <- predict(lm_train_courses)
unlog_forecast_lm <- exp(lm_train_data)
unlog_actual <- exp(train_set$ln_completed_ratio)
ggplot(train_set, aes(x = unlog_forecast_lm, y = unlog_actual)) + 
  geom_point() + 
  geom_smooth(method = lm) +  labs(title = "Forecast versus Actuals - Simple Linear Regression (Train Data)", x = "Forecast", y = "Actual")
```
 
## LASSO Regression
 
```{r}
#10 fold CV
train_control <-  trainControl(method = "cv", number = 10)
#Grid suggested by Angel fro 10 CV
grid <- seq(-2,10,length=100)

lasso_model <- train(ln_completed_ratio ~ institution + subject_cs + subject_stem + hours_certification_median + bachelor_ratio + grade_above_zero,
                     data = train_set, 
                     method = "glmnet", 
                     trControl = train_control,
                     metric =  "Rsquared",
                     tune_Grid = expand.grid(alpha = 1, lambda = grid))

lasso_model
```
 
 The best LASSO model has a $/alpha=0.1$ and $/lambda=0.014561213$. The RMSE value for this model is 0.7158, while the $R^2$ is 0.6047.

```{r}
lm_test_lasso_courses <- predict(lasso_model, test_set)
RMSE2 <- mean((lm_test_lasso_courses - test_set$ln_completed_ratio)^2) 
RMSE2

#Test Data
unlog_forecast_lasso <- exp(lm_test_lasso_courses)
unlog_actual <- exp(test_set$ln_completed_ratio)
ggplot(test_set, aes(x = unlog_forecast_lasso, y = unlog_actual)) + 
  geom_point() + 
  geom_smooth(method = lm) +  labs(title = "Forecast versus Actuals - LASSO (Test Data)", x = "Forecast", y = "Actual")

#Training Data
lasso_train_data <- predict(lasso_model)
unlog_forecast_lasso <- exp(lasso_train_data)
unlog_actual <- exp(train_set$ln_completed_ratio)
ggplot(train_set, aes(x = unlog_forecast_lasso, y = unlog_actual)) + 
  geom_point() + 
  geom_smooth(method = lm) +  labs(title = "Forecast versus Actuals - LASSO (Train Data)", x = "Forecast", y = "Actual")
```

## Ridge Regression
 
```{r}
ridge_model <- train(ln_completed_ratio ~ institution + subject_cs + subject_stem + hours_certification_median + bachelor_ratio + grade_above_zero,
                     data = train_set, 
                     method = "glmnet", 
                     trControl = train_control,
                     metric =  "Rsquared",
                     tune_Grid = expand.grid(alpha = 0, lambda = grid))

ridge_model
```

 The best Ridge model has a $/alpha=0.1$ and $/lambda=0.014561213$. The RMSE value for this model is 0.7247954, while the $R^2$ is 0.6214.
 
```{r}
lm_test_ridge_courses <- predict(ridge_model, test_set)
RMSE3 <- mean((lm_test_ridge_courses - test_set$ln_completed_ratio)^2) 
RMSE3

#Test Data
unlog_forecast_ridge <- exp(lm_test_ridge_courses)
unlog_actual <- exp(test_set$ln_completed_ratio)
ggplot(test_set, aes(x = unlog_forecast_ridge, y = unlog_actual)) + 
  geom_point() + 
  geom_smooth(method = lm) +  labs(title = "Forecast versus Actuals - Ridge (Test Data)", x = "Forecast", y = "Actual")

#Training Data
ridge_train_data <- predict(ridge_model)
unlog_forecast_ridge <- exp(ridge_train_data)
unlog_actual <- exp(train_set$ln_completed_ratio)
ggplot(train_set, aes(x = unlog_forecast_ridge, y = unlog_actual)) + 
  geom_point() + 
  geom_smooth(method = lm) +  labs(title = "Forecast versus Actuals - Ridge (Train Data)", x = "Forecast", y = "Actual")
```